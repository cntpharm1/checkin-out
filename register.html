<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ลงทะเบียน</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://static.line-scdn.net/liff/edge/2.1/sdk.js"></script>
</head>

<body class="bg-slate-100 min-h-screen">
  <div class="max-w-md m-auto p-2">
    <form>
      <div class="bg-white rounded-lg p-10">
        <div class="mb-5 text-center">
          <div class="mx-auto w-32 h-32 mb-2 border rounded-lg relative bg-slate-100 mb-4 shadow-inset">
            <img src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_960_720.png" alt="Default Image" id="preview" class="h-32 w-32 object-cover rounded-lg">
          </div>
          <label for="file" class="cursor-pointer inline-flex justify-between items-center p-2 rounded-lg text-slate-800 bg-slate-100 hover:bg-slate-300">
            อัพโหลดรูป
            <input type="file" id="file" name="file" accept="image/*" class="hidden">
          </label>
          <div class="mx-auto w-48 text-slate-500 text-xs text-center mt-1">คลิกเพื่ออัพโหลดรูปของคุณ</div>
        </div>

        <div class="flex flex-col">
          <input type="text" id="userlineId" placeholder="lineId" class="w-full bg-slate-200 p-2 text-center text-slate-500 rounded-lg mb-4" readonly>
          <input type="text" id="nameId" placeholder="ชื่อ-สกุล" class="w-full border p-2 rounded-lg mb-4" required>
          <input type="text" id="keynumberId" placeholder="รหัสพนักงาน" class="w-full border p-2 rounded-lg mb-4" required>
          <input type="text" id="keynumber2Id" placeholder="CHAT_ID" class="w-full border p-2 rounded-lg mb-4" required>
          <select id="departmentId" class="w-full border p-2 rounded-lg mb-6" required>
            <option value="" disabled selected>เลือกแผนก</option>
            <option value="PURCHASE">งานจัดซื้อ</option>
            <option value="STOCK">คลังยา</option>
            <option value="OPD">ห้องยาผู้ป่วยนอก</option>
            <option value="IPD">ห้องยาผู้ป่วยใน</option>
            <option value="MANU">งานผลิต</option>
            <option value="PRIMARY">งานปฐมภูมิ</option>
          </select>
        </div>

        <button type="button" id="submitBtn" class="bg-slate-800 text-white py-4 rounded-lg w-full hover:bg-blue-700">บันทึกข้อมูล</button>
      </div>
    </form>
  </div>

  <script>
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwQP2ufuABGdt3-Sk-ZRoMJZpKYbFPf5CZAcQHcs8JTo3eSF_43d_o49NuIPOSP3JQiFw/exec';
    const LIFF_ID = '2006631944-6E9e155O';

    const fileInput = document.getElementById("file");
    const imgPreview = document.getElementById("preview");
    const userlineIdInput = document.getElementById("userlineId");
    const nameIdInput = document.getElementById("nameId");
    const keynumberIdInput = document.getElementById("keynumberId");
    const keynumber2IdInput = document.getElementById("keynumber2Id");
    const deptIdInput = document.getElementById("departmentId");
    const submitBtn = document.getElementById("submitBtn");

    window.onload = function () {
      initializeLiff();
    };

    async function initializeLiff() {
      await liff.init({ liffId: LIFF_ID });
      if (liff.isLoggedIn()) {
        getUserProfile();
      } else {
        liff.login();
      }
    }

    async function getUserProfile() {
      try {
        const profile = await liff.getProfile();
        console.log('User Profile:', profile);
        userlineIdInput.value = profile.userId;
      } catch (error) {
        console.error('Profile Error:', error);
      }
    }

    fileInput.addEventListener('change', previewImage);

    function previewImage() {
      if (fileInput.files.length > 0) {
        const reader = new FileReader();
        reader.onload = e => imgPreview.src = e.target.result;
        reader.readAsDataURL(fileInput.files[0]);
      }
    }

    function validateForm() {
      return userlineIdInput.value && nameIdInput.value && keynumberIdInput.value && keynumber2IdInput.value && deptIdInput.value;
    }

    submitBtn.addEventListener('click', async () => {
      if (!validateForm()) {
        Swal.fire('Error', 'กรุณากรอกข้อมูลให้ครบ.', 'error');
        return;
      }

      const confirm = await Swal.fire({
        title: 'ยืนยันการส่งข้อมูล?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'ใช่',
        cancelButtonText: 'ยกเลิก'
      });

      if (!confirm.isConfirmed) return;

      submitBtn.disabled = true;

      try {
        let base64 = "";
        let fileType = "image/png";
        let fileName = "default.png";

        if (fileInput.files.length > 0) {
          const file = fileInput.files[0];
          base64 = await getBase64(file);
          fileType = file.type;
          fileName = file.name;
        } else {
          const response = await fetch(imgPreview.src);
          const blob = await response.blob();
          base64 = await getBase64(blob);
        }

        const data = {
          base64: base64,
          type: fileType,
          name: fileName,
          userlineId: userlineIdInput.value,
          nameId: nameIdInput.value,
          keynumberId: keynumberIdInput.value,
          keynumber2Id: keynumber2IdInput.value,
          deptID: deptIdInput.value
        };

        await fetch(WEB_APP_URL, {
          method: "POST",
          body: JSON.stringify(data),
          headers: { "Content-Type": "application/json" }
        });

        Swal.fire('Success', 'ข้อมูลถูกส่งเรียบร้อย', 'success').then(() => {
          liff.closeWindow();
        });

      } catch (error) {
        console.error('Submit Error:', error);
        Swal.fire('Error', 'เกิดข้อผิดพลาดในการส่งข้อมูล.', 'error');
      } finally {
        submitBtn.disabled = false;
      }
    });

    function getBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>

</html>
